// Enhanced schema for Outlook/Gmail/HubSpot-style inbox
// Run: npx prisma migrate dev --name inbox_enhancements

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// USER
// ============================================================
model User {
  id            Int                @id @default(autoincrement())
  empId         String             @unique
  name          String
  email         String             @unique
  password      String
  role          String             @default("user")
  createdAt     DateTime           @default(now())
  isAlive       Boolean?           @default(true)
  emailAccounts EmailAccount[]
  leadDetails   LeadDetails[]
  salesLeads    SalesLead[]
  scheduledMsgs ScheduledMessage[]
  tags          Tag[]
  emailComments EmailComment[]     // HubSpot-style internal comments
  sequences     EmailSequence[]    // Email sequences
  templates     EmailTemplate[]    // Email templates
}

// ============================================================
// EMAIL ACCOUNT - Enhanced with OAuth & Sync State
// ============================================================
model EmailAccount {
  id                Int                @id @default(autoincrement())
  userId            Int
  empId             String?
  email             String             @unique
  provider          String?            // gmail, outlook, zoho, generic
  
  // IMAP Settings
  imapHost          String?
  imapPort          Int?
  imapUser          String?
  imapSecure        Boolean?           @default(true)
  
  // SMTP Settings
  smtpHost          String?
  smtpPort          Int?
  smtpUser          String?
  smtpSecure        Boolean?           @default(true)
  
  // Auth - Password or OAuth
  authType          String             @default("password") // password, oauth2
  encryptedPass     String?
  
  // OAuth2 Tokens
  oauthClientId     String?
  oauthClientSecret String?
  refreshToken      String?
  accessToken       String?
  tokenExpiry       DateTime?
  
  // Gmail Push Notifications
  watchExpiry       DateTime?
  historyId         String?
  
  // Sync State
  verified          Boolean            @default(true)
  lastFullSyncAt    DateTime?
  lastSyncAt        DateTime?
  lastUid           Int?               @default(0)
  syncStatus        String?            @default("idle") // syncing, idle, error
  syncError         String?
  
  // Signature
  signature         String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  User              User               @relation(fields: [userId], references: [id])
  messages          EmailMessage[]
  conversations     Conversation[]
  scheduledMessages ScheduledMessage[]
  syncStates        SyncState[]
  folders           EmailFolder[]
  
  @@index([userId])
  @@index([email])
}

// ============================================================
// SYNC STATE - Track sync progress per folder
// ============================================================
model SyncState {
  id            Int           @id @default(autoincrement())
  accountId     Int
  folder        String
  uidValidity   BigInt        @default(0)
  lastUid       BigInt        @default(0)
  historyId     String?       // For Gmail
  lastSyncAt    DateTime?
  
  account       EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@unique([accountId, folder])
  @@index([accountId])
}

// ============================================================
// EMAIL FOLDER - Custom folder management
// ============================================================
model EmailFolder {
  id            Int           @id @default(autoincrement())
  accountId     Int
  name          String
  path          String        // IMAP path
  type          String?       // inbox, sent, drafts, trash, spam, archive, custom
  specialUse    String?       // \Inbox, \Sent, etc.
  parentId      Int?
  unreadCount   Int           @default(0)
  totalCount    Int           @default(0)
  color         String?
  
  account       EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  parent        EmailFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children      EmailFolder[] @relation("FolderHierarchy")
  
  @@unique([accountId, path])
  @@index([accountId])
}

// ============================================================
// EMAIL MESSAGE - Enhanced with all Outlook/Gmail features
// ============================================================
model EmailMessage {
  id              Int           @id @default(autoincrement())
  emailAccountId  Int
  conversationId  Int?
  leadDetailId    Int?
  salesLeadId     Int?
  
  // Core fields
  messageId       String?       // RFC Message-ID
  uid             Int?          // IMAP UID
  gmailId         String?       // Gmail-specific ID
  
  // Threading (RFC 2822)
  threadId        String?
  inReplyTo       String?
  references      String?       // Comma-separated Message-IDs
  
  // Email content
  subject         String?
  fromEmail       String
  fromName        String?
  toEmail         String
  ccEmail         String?
  bccEmail        String?
  replyTo         String?
  body            String?
  bodyHtml        String?
  bodyText        String?       // Plain text version
  snippet         String?       // Preview text (first 100 chars)
  
  // Direction & Status
  direction       String        // sent, received
  sentAt          DateTime      @default(now())
  receivedAt      DateTime?
  
  // Flags (synced with IMAP)
  isRead          Boolean       @default(false)
  isStarred       Boolean       @default(false)
  isFlagged       Boolean       @default(false)  // Outlook follow-up flag
  isImportant     Boolean       @default(false)
  isDraft         Boolean       @default(false)
  isSpam          Boolean       @default(false)
  isTrash         Boolean       @default(false)
  isArchived      Boolean       @default(false)
  
  // Folder
  folder          String?       @default("inbox")
  labelIds        String?       // Gmail labels as JSON array
  categories      String?       // Outlook categories as JSON array
  
  // Snooze feature
  isSnoozed       Boolean       @default(false)
  snoozedUntil    DateTime?
  originalFolder  String?
  
  // Email Tracking (HubSpot-style)
  trackOpens      Boolean       @default(false)
  trackClicks     Boolean       @default(false)
  openCount       Int           @default(0)
  clickCount      Int           @default(0)
  lastOpenedAt    DateTime?
  lastClickedAt   DateTime?
  
  // Priority (Outlook)
  priority        String?       @default("normal") // low, normal, high
  importance      String?       @default("normal")
  
  // UI State (not synced)
  hasBody         Boolean       @default(false)
  hideInbox       Boolean?      @default(false)
  hideTrash       Boolean?      @default(false)
  
  // Relations
  attachments     Attachment[]
  emailAccount    EmailAccount  @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)
  conversation    Conversation? @relation(fields: [conversationId], references: [id])
  leadDetail      LeadDetails?  @relation(fields: [leadDetailId], references: [id])
  salesLead       SalesLead?    @relation(fields: [salesLeadId], references: [id])
  tags            MessageTag[]
  comments        EmailComment[]
  trackingEvents  TrackingEvent[]
  
  @@unique([emailAccountId, messageId])
  @@index([uid])
  @@index([emailAccountId, folder])
  @@index([emailAccountId, sentAt])
  @@index([threadId])
  @@index([fromEmail])
  @@index([toEmail])
}

// ============================================================
// CONVERSATION / THREAD - Gmail-style threading
// ============================================================
model Conversation {
  id               Int                @id @default(autoincrement())
  accountId        Int
  
  // Thread identifiers
  threadId         String?            // Unique thread ID
  subject          String?            // Normalized subject
  
  // Participants
  fromEmail        String?
  toEmail          String?
  participants     String?            // JSON array of all participants
  
  // Status
  unread           Boolean            @default(false)
  unreadCount      Int                @default(0)
  messageCount     Int                @default(0)
  
  // Latest message info
  lastMessageAt    DateTime           @default(now())
  lastSnippet      String?
  lastSender       String?
  
  // Flags
  isStarred        Boolean            @default(false)
  isSnoozed        Boolean            @default(false)
  snoozedUntil     DateTime?
  
  // HubSpot CRM linking
  contactId        Int?
  dealId           Int?
  assignedToId     Int?
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  
  // Relations
  emailAccount     EmailAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tags             ConversationTag[]
  messages         EmailMessage[]
  scheduledMessage ScheduledMessage[]
  comments         EmailComment[]
  
  @@unique([accountId, threadId])
  @@index([accountId, lastMessageAt])
}

// ============================================================
// EMAIL COMMENT - HubSpot-style internal notes
// ============================================================
model EmailComment {
  id             Int           @id @default(autoincrement())
  userId         Int
  messageId      Int?
  conversationId Int?
  content        String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  user           User          @relation(fields: [userId], references: [id])
  message        EmailMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([conversationId])
}

// ============================================================
// EMAIL TEMPLATE - Reusable templates
// ============================================================
model EmailTemplate {
  id          Int       @id @default(autoincrement())
  userId      Int
  name        String
  subject     String?
  bodyHtml    String
  category    String?
  isShared    Boolean   @default(false)
  useCount    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

// ============================================================
// EMAIL SEQUENCE - HubSpot-style automated sequences
// ============================================================
model EmailSequence {
  id          Int              @id @default(autoincrement())
  userId      Int
  name        String
  description String?
  status      String           @default("draft") // draft, active, paused
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  user        User             @relation(fields: [userId], references: [id])
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]
  
  @@index([userId])
}

model SequenceStep {
  id          Int           @id @default(autoincrement())
  sequenceId  Int
  stepNumber  Int
  delayDays   Int           @default(1)
  delayHours  Int           @default(0)
  subject     String?
  bodyHtml    String
  
  sequence    EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  @@index([sequenceId])
}

model SequenceEnrollment {
  id          Int           @id @default(autoincrement())
  sequenceId  Int
  contactEmail String
  currentStep Int           @default(0)
  status      String        @default("active") // active, completed, paused, bounced
  enrolledAt  DateTime      @default(now())
  nextSendAt  DateTime?
  
  sequence    EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  @@index([sequenceId])
  @@index([contactEmail])
}

// ============================================================
// TRACKING EVENT - Email opens and clicks
// ============================================================
model TrackingEvent {
  id          Int           @id @default(autoincrement())
  messageId   Int
  type        String        // open, click
  ipAddress   String?
  userAgent   String?
  linkUrl     String?       // For click events
  occurredAt  DateTime      @default(now())
  
  message     EmailMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([occurredAt])
}

// ============================================================
// ATTACHMENT - Enhanced with deduplication
// ============================================================
model Attachment {
  id         Int          @id @default(autoincrement())
  messageId  Int
  filename   String
  mimeType   String?
  size       Int?
  storageUrl String?      // R2 URL
  data       Bytes?       // For small inline attachments
  cid        String?      // Content-ID for inline images
  hash       String?      // For deduplication
  isInline   Boolean      @default(false)
  uploadedAt DateTime     @default(now())
  
  message    EmailMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([hash])
}

// ============================================================
// EXISTING MODELS (Enhanced)
// ============================================================

model SalesLead {
  id            Int            @id @default(autoincrement())
  client        String
  email         String?
  cc            String?
  empId         String?
  phone         String?
  country       String?
  subject       String?
  body          String?
  response      String?
  leadType      String?
  Result        String?
  createdAt     DateTime       @default(now())
  leadStatus    String         @default("New")
  userId        Int?
  leadDetailsId Int?
  EmailMessage  EmailMessage[]
  leadDetails   LeadDetails?   @relation(fields: [leadDetailsId], references: [id])
  user          User?          @relation(fields: [userId], references: [id])
  
  @@index([email])
}

model LeadDetails {
  id              Int            @id @default(autoincrement())
  date            DateTime?
  client          String
  email           String
  cc              String?
  empId           String?
  phone           String?
  subject         String?
  body            String?
  response        String?
  leadType        String?
  leadStatus      String?        @default("New")
  brand           String?
  country         String?
  salesperson     String?
  result          String?
  companyName     String?
  meetingNotes    String?
  followUpDate    DateTime?
  day             String?
  followUpHistory Json?
  dealValue       Float?
  createdAt       DateTime       @default(now())
  lastUpdated     DateTime       @updatedAt
  active          Boolean?       @default(true)
  isFollowedUp    Boolean        @default(false)
  userId          Int?
  messages        EmailMessage[]
  user            User?          @relation(fields: [userId], references: [id])
  SalesLead       SalesLead[]
  
  @@index([email])
}

model Tag {
  id               Int               @id @default(autoincrement())
  userId           Int
  empId            String?
  name             String
  color            String?
  createdAt        DateTime          @default(now())
  conversationTags ConversationTag[]
  messageTags      MessageTag[]
  user             User              @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

model ConversationTag {
  conversationId Int
  tagId          Int
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Tag            Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([conversationId, tagId])
}

model MessageTag {
  messageId Int
  tagId     Int
  Message   EmailMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  Tag       Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([messageId, tagId])
}

model ScheduledMessage {
  id             Int           @id @default(autoincrement())
  userId         Int
  empId          String?
  accountId      Int
  conversationId Int?
  toEmail        String
  ccEmail        String?
  subject        String?
  bodyHtml       String
  sendAt         DateTime
  status         String        @default("pending") // pending, sent, failed, cancelled
  attachments    Json?
  retryCount     Int           @default(0)
  errorMessage   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  isFollowedUp   Boolean?      @default(false)
  
  emailAccount   EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  
  @@index([status, sendAt])
  @@index([accountId])
}
